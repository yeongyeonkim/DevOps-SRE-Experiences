## Pod 간 통신 장애 분석 보고서

### 1. 배경
A 서비스에서 B 서비스로의 Pod 간 API 호출 중, 특정 Namespace 내 단 한 대의 Pod에서 약 **15초간 `java.net.UnknownHostException`**이 발생하였다.

- **트랜잭션 로그 예시**
  ```
  10:10:17.414 [FeignClient] service-b.service-b.svc.cluster.local:80 /api
  10:10:22.470 service-b.service-b.svc.cluster.local [Socket] 0.0.0.0:80
  ```
  → 5초 소요 후 `0.0.0.0` 반환 (DNS 조회 실패로 판단)

---

### 2. 원인 분석

#### (1) Trace 분석 결과
- 호출 흐름: `Application → Feign Client → HTTP Client (Sleuth) → Network`
- **Network 단계의 `lookupAllHostAddr`(DNS 조회)에서 종료됨**
- **정상 흐름**: DNS 조회 → TCP 연결 → HTTP 요청 → 응답 대기  
- **현재 흐름**: DNS 조회 실패로 IP 탐색 불가 → 연결 불가

![activestack](img/activestack.png)

#### (2) Pod DNS 설정
```
nameserver 172.20.0.1
nameserver 8.8.8.8
options ndots:5
```

#### (3) Java DNS Cache 설정
```
#networkaddress.cache.ttl=-1
networkaddress.cache.negative.ttl=10
```

#### (4) 문제 원인 요약
- 클러스터 내부 도메인(`service-b.namespace.svc.cluster.local`)이 외부 DNS(8.8.8.8)에 질의됨
- 외부 DNS는 내부 도메인을 인식하지 못하므로 **NXDOMAIN 반환**
- Java가 이 실패 결과를 **10초간 캐시**함
- 그동안 모든 요청이 `UnknownHostException (0.0.0.0)`을 발생시킴

---

### 3. 개선 사항

#### (1) Pod DNS 설정 개선
| 항목 | 변경 전 | 변경 후 | 비고 |
|------|----------|----------|------|
| nameserver | 172.20.0.1, 8.8.8.8 | 172.20.0.1 | 외부 DNS 제거 |
| ndots | 5 | 2 | 내부 질의 횟수 감소 |
| timeout | 기본값 | 3초 | 재시도 간격 단축 |
| attempts | 기본값 | 3회 | DNS 재시도 횟수 증가 |

> 외부 DNS 제거 및 ndots 조정으로 내부 DNS 질의 집중, 실패율 감소

---

#### (2) Java DNS Cache 설정 변경
- 성공/실패 캐시 시간을 짧게 조정하여 **롤링 업데이트 시 유연 대응**
  ```bash
  networkaddress.cache.ttl=10
  networkaddress.cache.negative.ttl=0
  ```
- 성공 캐시: 10초 → IP 변경에 빠르게 대응
- 실패 캐시: 0초 → NXDOMAIN 즉시 재시도 가능

> 클라우드 환경에서는 리소스 변경이 빈번하므로 짧은 TTL 유지가 권장됨

---

#### (3) CoreDNS 설정 개선
AZ 및 Node 간 균등 분포를 위한 **topologySpreadConstraints** 추가:
```yaml
spec:
  template:
    spec:
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            k8s-app: kube-dns
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            k8s-app: kube-dns
```
> CoreDNS Pod이 Zone 및 Node에 고르게 배포되어 DNS 응답 지연 최소화

---

#### (4) NodeLocal DNSCache 도입
- 각 노드에 DaemonSet 형태로 **DNS 캐시 에이전트** 구성
- CoreDNS 부하 감소 및 조회 지연 단축 효과

> CoreDNS 대신 NodeLocalDNS를 통해 네트워크 홉을 줄이고 장애 범위를 축소

---

### 4. 추가 의문점
1. **CoreDNS가 일시적으로 응답하지 못한 이유**
   - Prometheus 지표상 리소스 이상 없음
   - NXDOMAIN 응답 비율도 정상
   - Control-plane 로그 미수집으로 원인 추적 불가

2. **A→B 호출만 영향을 받은 이유**
   - 특정 시점의 DNS 질의 타임아웃으로 일부 Pod만 영향 가능성 존재
   - 동일 네임서버 공유로 인한 일시적 장애 추정

---

### 5. 참고 문서
- [Linux resolv.conf 매뉴얼](https://man7.org/linux/man-pages/man5/resolv.conf.5.html)

