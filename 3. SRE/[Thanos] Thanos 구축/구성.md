### 배경

<b>스타벅스 사이렌 오더 Observability 시스템 구축</b>

1. AWS PVC 이슈
 HA 구성을 하지 않으며 PVC를 사용한 우리 프로젝트의 경우, 새로운 노드로의 마이그레이션이 필요한 경우 노드 및 볼륨의 Zone에 차이가 생기는 경우 PVC가 붙을 수 없어 관련 Pod 들이 모두 Pending이 되게 된다.

2. 시스템의 확장
 앞으로 우리의 Logs, Metrics, Traces를 담당할 주요 시스템의 데이터가 유실되는 등 불완전성을 갖고있다면 이는 개선되어야 할 부분일 것이다.
 미래 상황을 고려하여 고가용성 + 확장성있는 시스템 구성이 필요하다.

![cncf](img/cncf.png)

현 시점에선 Object Storage로서 Thanos를 활용하는 것이 좋아보인다.

#### Prometheus 상태 점검

[Prometheus] 상태 점검(Cardinality, etc)
페이지에 정리해두었다.

#### Thanos의 필요성

프로메테우스는 단일 노드 시스템으로 설계되어 클러스터링 구조를 직접 지원하지 않는다.
때문에 '확장성'과 '고가용성'에 일부 보완이 필요하다.

1. 확장성
 - 단일 노드에서 모든 메트릭을 처리하려 할 때, 노드의 자원이 고갈되어 성능 저하를 초래할 수 있다.
  => 외부 스토리지 연결의 필요

2. 고가용성 문제
 - 단일 노드에서 발생하는 장애나 다운타임이 생겨 프로메테우스 서버가 내려가면 그 시간 동안 메트릭을 수집할 수 없다.
 - Amazon EBS CSI Driver 를 통한 EBS를 사용해도 단일 노드에만 가능하다. (또한 AZ 일치까지 해야함)
  => 이를 방지하기 위해 HA 구성하게 되고, 데이터 정합성을 보장할 수 있어야 함.

위 내용을 해결하기 위한 도구가 Thanos

### PoC

![multicluster](img/multicluster.png)

멀티클러스터에서도 활용 가능한 Prometheus 환경을 구성하고싶다.

1. kube-prometheus-stack에 Thanos Sidecar를 구성한다.
