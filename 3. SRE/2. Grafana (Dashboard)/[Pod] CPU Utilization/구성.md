1. ëª©í‘œ
* Pod ë³„ CPU Utilizationì´ 60%, 80% ë„˜ëŠ” ê²½ìš° ê°ê° Warning, Critical ì•Œë¦¼ì„ ë°›ëŠ”ë‹¤.
* Prometheus Ruleì´ êµ¬ì„±ì—ëŠ” ë” ì‰½ê² ì§€ë§Œ.. íŒ€ ë‚´ë¶€ì ì¸ ì´ìœ ë¡œ Grafana Alert ruleì„ í™œìš©í•´ë³¸ë‹¤.

2. ì¿¼ë¦¬ ë° ì•ŒëŒ ì¡°ê±´ ì •ì˜
A:
```
(
  rate(container_cpu_usage_seconds_total{namespace=~"$namespace", container!="POD",container!=""}[3m]) * 100
) > 60
and on(pod, namespace) 
(
  (time() - kube_pod_created{}) > 600
)
```

B: Reduce (Last)
C: Threshold (Input: B, IS ABOVE: 0)

â€» **Reduce Lastë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° Time Rangeë¥¼ ê¼­ ì„¤ì •í•´ì£¼ì–´ì•¼ í•œë‹¤.

![1](img/1.png)

why?: ëŒ€ë¶€ë¶„ì˜ Queryì˜ ê²°ê³¼ëŠ” time seriesì¸ë°, Grafanaì—ì„œ Alert ruleì„ ìƒì„±í•  ë•Œ
time seriesë¡œì˜ thresholdë¥¼ Alert condition ìœ¼ë¡œ ë‘ë ¤ê³ í•˜ë©´ 
`You cannot use time series data as an alert condition, consider adding a reduce expression.` ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤. 
ë”°ë¼ì„œ time series ë°ì´í„°ë¥¼ ë‹¨ì¼ ê°’ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” reduce expressionì„ ì¶”ê°€í•´ì•¼ í•œë‹¤. 
Grafanaì—ì„œëŠ” ì‹œê³„ì—´ ë°ì´í„°ì˜ ì—¬ëŸ¬ ë°ì´í„° í¬ì¸íŠ¸ë¥¼ í•˜ë‚˜ì˜ ê°’ìœ¼ë¡œ ì§‘ê³„í•´ì•¼ë§Œ thresholdì™€ ë¹„êµí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.

ê·¼ë° ì´ì œ ì´ reduceê°€ ê°ì§€í•˜ëŠ” ë²”ìœ„ê°€ ë„“ì€ ë²”ìœ„ë¡œ ì¸í•œ Time Rangeì— ê±¸ë¦¬ë©´ Firingì´ ê³„ì† ìœ ì§€ë˜ëŠ” ê²½í—˜ì„ í•  ìˆ˜ ìˆë‹¤.
ì•Œê³ ë³´ë©´ ë‹¹ì—°í•œë° ì´ ì„¤ì •ë•Œë¬¸ì— ë‹¤ë¥¸ê±° ë‹¤ ë§Œë“¤ì–´ë†“ê³  í•œì°¸ì„ í—¤ë§¸ë‹¤..

3. Evaluation behavior

* evaluation 1m ì´í•˜ë¡œ

* pending period: ì¦‰ì‹œ(None or 0s)

4. Label, Notification êµ¬ì„±

* Labelì€ titleê³¼ messageì— ë“¤ì–´ê°ˆ namespace: {{ $labels.namespace }}ì™€ severity: Warning or Critical ì„¤ì •í•œë‹¤.

* Notification Templates

í…œí”Œë¦¿ì€ ëŒ€ì¶© ë‹¤ìŒê³¼ ê°™ë‹¤. (ê°œì„ ì´ ì¡°ê¸ˆë„ ë˜ì§€ì•Šì€ ì„ì‹œë²„ì „)

![2](img/2.png)

```
{{ define "pod.title" }}
  [{{ .CommonLabels.severity | title }}][{{ .CommonLabels.pod }}][CPU] - ({{ .Status | title }})
{{ end }}
```

```
{{ define "teams-pod-message" }}
{{ range .Alerts }}
ğŸ”¸ **Pod ì •ë³´:** ğŸ”¸
- **Pod:** {{ .Labels.pod }}
- **Namespace:** {{ .Labels.namespace }}
- **Severity:** {{ .Labels.severity }}

**ìš”ì•½**
- {{ if eq .Labels.severity "Warning" }}1ë¶„ê°„ CPU ì‚¬ìš©ëŸ‰ 60% ì´ˆê³¼{{ else if eq .Labels.severity "Critical" }}1ë¶„ê°„ CPU ì‚¬ìš©ëŸ‰ 80% ì´ˆê³¼{{ else }}CPU ì‚¬ìš©ëŸ‰ ì„ê³„ê°’ ì´ˆê³¼{{ end }}


**ì¡°ì¹˜ ë°©ë²•**
- ArgoCD ì ‘ì† í›„, maxReplicas ìƒí–¥ ì¡°ì •
{{ end }}
{{ end }}
```

* Contact point

ìœ„ í…œí”Œë¦¿ë“¤ì„ title, messageë¡œ ì§€ì •í•˜ê³  webhookì€ microsoft teams webhookì„ ì„¤ì •í•œë‹¤.

5. Microsoft Teams ì„¤ì •

![3](img/3.png)

6. K6ë¥¼ í†µí•œ ë¶€í•˜ ë° ê²°ê³¼ í™•ì¸

![4](img/4.png)

![5](img/5.png)