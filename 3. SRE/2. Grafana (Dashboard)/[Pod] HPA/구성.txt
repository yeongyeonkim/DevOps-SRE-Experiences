HPA Scaling 조건

우리의 오토스케일링 기준은 CPU Utilization 45% 이상일 때 입니다.

아래와 같은 CPU Utilization 쿼리를 사용하고 있다.(k8s 내 metrics server 수집 기준과 유사)

sum(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{namespace=~"$namespace"}) by (namespace, pod)
/ sum(cluster:namespace:pod_cpu:active:kube_pod_container_resource_requests{namespace=~"$namespace"}) by (namespace, pod) * 100

이를 기준으로 노이즈는 제거하면서 Scaling Out가 발생했는지 알 수 있는 promql은 무엇일까요?


(
  avg_over_time(
    (
      sum(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{namespace=~"$namespace"}) by (namespace, pod)
      / sum(cluster:namespace:pod_cpu:active:kube_pod_container_resource_requests{namespace=~"$namespace"}) by (namespace, pod) * 100
    )[10m:1m]
  )
) > 45
and on(namespace)
(
  count by (namespace) (sum(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{namespace=~"$namespace"}) by (namespace, pod))
  >
  count by (namespace) (sum(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{namespace=~"$namespace"}) by (namespace, pod) offset 15m)
)


promql

케이스 정리
 1. HPA가 발생 + Pod CPU가 40% 이상인 경우(CPU Threshold보다 살짝 하향)
 2. HPA가 발생하였는데 CPU가