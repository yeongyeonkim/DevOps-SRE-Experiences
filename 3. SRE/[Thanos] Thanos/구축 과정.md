### 배경

<b>스타벅스 사이렌 오더 Observability 시스템 구축</b>

1. AWS PVC 이슈
 HA 구성을 하지 않으며 PVC를 사용한 우리 프로젝트의 경우, 새로운 노드로의 마이그레이션이 필요한 경우 노드 및 볼륨의 Zone에 차이가 생기는 경우 PVC가 붙을 수 없어 관련 Pod 들이 모두 Pending이 되게 된다.

2. 시스템의 확장
 앞으로 우리의 Logs, Metrics, Traces를 담당할 주요 시스템의 데이터가 유실되는 등 불완전성을 갖고있다면 이는 개선되어야 할 부분일 것이다.
 미래 상황을 고려하여 고가용성 + 확장성있는 시스템 구성이 필요하다.

3. 시계열의 증가에 대한 대응
 대시보드가 많아지고, Grafana Alert을 계속 설정하면서
 시계열이 급격하게 많아지고 Prometheus memory 사용률 또한 증가했다.

![cncf](img/cncf.png)

현 시점에선 Object Storage로서 Thanos를 활용하는 것이 좋아보인다.

#### Prometheus 상태 점검

[Prometheus] 운영 중 발생한 시계열 증가 대응 및 최적화 경험
페이지에 정리해두었다.

#### Thanos의 필요성

프로메테우스는 단일 노드 시스템으로 설계되어 클러스터링 구조를 직접 지원하지 않는다.
때문에 '확장성'과 '고가용성'에 일부 보완이 필요하다.

1. 확장성
 - 단일 노드에서 모든 메트릭을 처리하려 할 때, 노드의 자원이 고갈되어 성능 저하를 초래할 수 있다.
  => 외부 스토리지 연결의 필요

2. 고가용성 문제
 - 단일 노드에서 발생하는 장애나 다운타임이 생겨 프로메테우스 서버가 내려가면 그 시간 동안 메트릭을 수집할 수 없다.
 - Amazon EBS CSI Driver 를 통한 EBS를 사용해도 단일 노드에만 가능하다. (또한 AZ 일치까지 해야함)
  => 이를 방지하기 위해 HA 구성하게 되고, 데이터 정합성을 보장할 수 있어야 함.

위 내용을 해결하기 위한 도구가 Thanos

### 구성 (테스트 환경 PoC)

#### Thanos 구성(Terraform)

Sidecar 방식으로 구성을 하겠다. - [참고](https://prometheus-operator.dev/docs/platform/thanos/)

1. Thanos Sidecar가 포함된 Prometheus CRD

 - 사이드카를 활성화하기 위한 가장 쉬운 방법은 
 prometheusOperator의 컨테이너 이미지를 설정하는 것이다.

```
  prometheusOperator = {
    thanosImage = {
      repository = "quay.io/thanos/thanos"
      tag        = "v0.37.2"
    }
```

2. Thanos Object Storage 구성

[thanos 객체 스토리지](https://github.com/thanos-io/thanos/blob/main/docs/storage.md)

thanos-config.yaml

```
type: S3
config:
  bucket: "thanos-bucket"
  endpoint: "s3.ap-northeast-2.amazonaws.com"
  region: "ap-northeast-2"
  # access_key: "{aws access_key}"
  # secret_key: "{aws secret_key}"
```

$ kubectl -n monitoring create secret generic thanos-objstore-config --from-file=thanos.yaml=/tmp/thanos-config.yaml

권한에 대한 것은 ServiceAccount IRSA로 대체한다.

이후, prometheus thanos 필드에 secret을 지정한다.

```
prometheusSpec = {
  ...
  thanos = {
    objectStorageConfig = {
      key  = "thanos.yaml"
      name = "thanos-objstore-config"
    }
  }
  ...
```

이렇게 하면 Prometheus가 2시간마다 생성하는 모든 새 블록을 개체 저장소에 백업하는 Thanos 사이드카가 연결된다.




