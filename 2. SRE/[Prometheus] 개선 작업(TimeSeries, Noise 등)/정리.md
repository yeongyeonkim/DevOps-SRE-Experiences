![rate](img/rate.png)
[공식 문서](https://prometheus.io/docs/prometheus/latest/querying/functions/#rate)

rate()에 대해서 다음과 같이 공식문서에서 설명하고 있다.
the per-second average rate of increase of the time series in the range vector

보통 우리는 rate = (마지막 값 - 첫번째 값) / (마지막 타임스탬프 - 첫번째 타임스탬프) 수식으로
첫번 째, 마지막 값만 비교해서 올 것 같지만 항상 그렇지는 않다.

예를 들어 CPU 사용량(container_cpu_usage_seconds_total)로 볼 때 
rate는 각 포인트의 평균값이 아니라 증가율(기울기)을 계산한다.

실제로 알람이 10:06:00에 왔다면
 * 이전 평가(Evaluation)는 10:05:30에 실행이 되었을 거고
 * 지금 평가에서는 10:05:00 ~ 10:06:00 구간을 사용하게 된다.

이 구간에서의 변화 흐름
 * 초반(10:05:00~10:05:30): 낮음 (13→39)
 * 후반(10:05:30~10:06:00): 급상승 (39→61)

============ LabelOptimization ============
※ container_cpu_usage_seconds_total
 - 이 지표는 Linux 커널의 cgroups 데이터에서 파생된다. 구체적으로 /sys/fs/cgroup/cpu/cpu.usage_us 
   cgroup 버전에 따라 데이터를 읽어 컨테이너 프로세스가 CPU에서 소비한 시간(마이크로초)을 나타낸다.

[식별가능한 레이블]
 container- 컨테이너 이름
 pod- 실행 중인 포드
 namespace- 쿠버네티스 네임스페이스
 id- 컨테이너 ID
 image- 컨테이너 이미지
 name- cgroup 이름

1. Pause 컨테이너, kube-proxy 등 일부 시스템 컨테이너는 image 라벨이 비어있다.
   때문에 {image!=""}와 같은 쿼리문을 추가해서 실제 애플리케이션 컨테이너만 계산할 수 있다.

2. 노드 단위(System) 메트릭이나 이미 종료된 컨테이너의 잔여 메트릭을 제외하기 위해 container!="" 도 활용한다.

이를 프로메테우스를 통해 확인해보자

![seriesOptimization1](img/seriesOptimization1.png)
실제로 container_cpu_usage_seconds_total를 하게되면 series가 1780인데
쿼리에 image!=""를 통해 관리형 컨테이너들을 제거해보면

![seriesOptimization2](img/seriesOptimization2.png)
존재했던 kube-proxy 시계열이 없으며, series가 1266개가 된 모습

![seriesOptimization3](img/seriesOptimization3.png)
쿼리에 container!=""를 통해 불필요한 멭릑을 제거하여 744개






=================

Rate() 함수의 범위를 설정할 때 시간(Range)은 스크랩 간격(Scrape Interval)의 최소 4배 이상으로 설정하는 것이 좋다고 한다.
이 규칙으로 갑작스러운 트래픽 증가에 더 탄력적으로 대응하고, 실패한 스크랩으로 인한 데이터 손실을 최소화하며, 그래프의 오류를 줄이는 데 도움이 된다.
